# Best-effort anti-abuse limits
limit_req_zone $binary_remote_addr zone=req_per_ip:10m rate=10r/s;
limit_conn_zone $binary_remote_addr zone=conn_per_ip:10m;

server {
  listen 80;
  server_name _;

  root /usr/share/nginx/html;
  index index.html;

  # Redirect all HTTP requests to the canonical host over HTTPS
  if ($http_x_forwarded_proto = "http") {
    return 301 https://instalaciones.geonet.cl$request_uri;
  }
  if ($scheme = "http") {
    return 301 https://instalaciones.geonet.cl$request_uri;
  }

  # ==========================================
  # MEDIDAS ANTI-DDOS Y HARDENING BÁSICO
  # ==========================================
  server_tokens off;
  add_header X-XSS-Protection "1; mode=block" always;
  limit_req_status 429;
  limit_conn_status 429;
  limit_conn conn_per_ip 20;

  client_header_timeout 10s;
  client_body_timeout 10s;
  send_timeout 10s;
  keepalive_timeout 15s;
  reset_timedout_connection on;

  large_client_header_buffers 4 8k;
  client_max_body_size 50m; # Permitir subida de imágenes (carnet, etc.)

  # DNS Resolver de Docker para prevenir error 502
  resolver 127.0.0.11 valid=10s ipv6=off;


  # ==========================================
  # RUTAS (LOCATIONS) DEL FRONTEND
  # ==========================================

  # 1. Assets estáticos (Vite/React)
  location /assets/ {
    expires 1y;
    add_header Cache-Control "public, immutable, max-age=31536000" always;
    
    # Cabeceras de seguridad (Con blob: permitido para imágenes)
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Frame-Options "DENY" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Permissions-Policy "geolocation=(self), microphone=(), camera=()" always;
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' https://maps.googleapis.com https://static.cloudflareinsights.com; style-src 'self' https://fonts.googleapis.com; img-src 'self' data: blob: https://geonet.cl https://maps.gstatic.com https://maps.googleapis.com https://cdn.jsdelivr.net; connect-src 'self' https://maps.googleapis.com https://www.googleapis.com https://ipapi.co; font-src 'self' https://fonts.gstatic.com data:; object-src 'none'; base-uri 'self'; frame-ancestors 'none'; form-action 'self';" always;
  }

  # 2. Ruta principal SPA (index.html)
  location / {
    limit_req zone=req_per_ip burst=30 nodelay;
    try_files $uri $uri/ /index.html;
    
    # Bloqueo de caché para el index.html
    add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
    add_header Pragma "no-cache" always;
    add_header Expires "0" always;

    # Cabeceras de seguridad (Con blob: permitido para imágenes)
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Frame-Options "DENY" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Permissions-Policy "geolocation=(self), microphone=(), camera=()" always;
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' https://maps.googleapis.com https://static.cloudflareinsights.com; style-src 'self' https://fonts.googleapis.com; img-src 'self' data: blob: https://geonet.cl https://maps.gstatic.com https://maps.googleapis.com https://cdn.jsdelivr.net; connect-src 'self' https://maps.googleapis.com https://www.googleapis.com https://ipapi.co; font-src 'self' https://fonts.gstatic.com data:; object-src 'none'; base-uri 'self'; frame-ancestors 'none'; form-action 'self';" always;
  }

  # 3. Otros archivos estáticos en la raíz
  location ~* \.(?:js|css|png|jpg|jpeg|gif|svg|ico|webp|woff2?)$ {
    limit_req zone=req_per_ip burst=120 nodelay;
    expires 30d;
    add_header Cache-Control "public, max-age=2592000, immutable" always;
    
    # Cabeceras de seguridad (Con blob: permitido para imágenes)
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Frame-Options "DENY" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Permissions-Policy "geolocation=(self), microphone=(), camera=()" always;
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' https://maps.googleapis.com https://static.cloudflareinsights.com; style-src 'self' https://fonts.googleapis.com; img-src 'self' data: blob: https://geonet.cl https://maps.gstatic.com https://maps.googleapis.com https://cdn.jsdelivr.net; connect-src 'self' https://maps.googleapis.com https://www.googleapis.com https://ipapi.co; font-src 'self' https://fonts.gstatic.com data:; object-src 'none'; base-uri 'self'; frame-ancestors 'none'; form-action 'self';" always;

    try_files $uri =404;
  }


  # ==========================================
  # API BACKEND - MODO LISTA BLANCA ESTRICTA
  # ==========================================

  # A) BLOQUEO POR DEFECTO: Todo intento a /api/ que no esté autorizado recibe error 403.
  location /api/ {
      return 403;
  }

  # B) LISTA BLANCA: Únicamente permitimos el endpoint de instalaciones.
  location ~ ^/api/(installations) {
    limit_req zone=req_per_ip burst=60 nodelay;
    
    # BLOQUEO DE NAVEGACIÓN DIRECTA
    if ($http_sec_fetch_mode = "navigate") {
        return 301 https://instalaciones.geonet.cl/;
    }

    proxy_hide_header Strict-Transport-Security;

    set $api_upstream http://api:3000;
    rewrite ^/api/(.*) /$1 break;
    proxy_pass $api_upstream;

    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_cache_bypass $http_upgrade;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;
  }
}
